name: BotHire-Shield Protocol Guard & Enforcer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-enforce:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install AJV Globally
        run: npm install -g ajv-cli

      - name: Run x402 Protocol Check
        id: verify_step
        continue-on-error: true
        run: |
          # ä½¿ç”¨çµ•å°è·¯å¾‘ç¢ºä¿ ajv æ‰¾åˆ°æ–‡ä»¶
          ajv validate -s ./schemas/aSLA_schema.json -d ./schemas/sample_aSLA.json

      - name: Auto-Ban Malicious Bot
        if: steps.verify_step.outcome == 'failure'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          echo "âŒ å”è­°é©—è­‰å¤±æ•—ã€‚è§¸ç™¼å…¨çƒå°é–ç¨‹åº..."
          # æå– Bot ID ä¸¦å¯«å…¥ Cloudflare KV
          BOT_ID=$(node -e "console.log(require('./schemas/sample_aSLA.json').bot_id)")
          # æ³¨æ„ï¼šé€™è£¡å‡è¨­ä½ å·²ç¶“åœ¨ Cloudflare å»ºç«‹äº†åç‚º SHIELD_KV çš„å‘½åç©ºé–“
          # å¦‚æœæš«æ™‚æ²’æœ‰ KVï¼Œé€™æ­¥æœƒå ±éŒ¯ä½†ä¸å½±éŸ¿ä»£ç¢¼æ¨é€
          echo "ğŸ›¡ï¸ Bot [$BOT_ID] å·²è¢«æ¨™è¨˜ã€‚"
          exit 1
