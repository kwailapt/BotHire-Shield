name: BotHire-Shield Protocol Guard & Enforcer

on:
  push:
    branches: [ main ]

jobs:
  validate-and-enforce:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install AJV
        run: npm install -g ajv-cli

      - name: Run x402 Protocol Check
        id: verify_step
        continue-on-error: true
        run: |
          ajv validate -s ./schemas/aSLA_schema.json -d ./schemas/sample_aSLA.json

      - name: ğŸš¨ On-Chain Enforcement (Base Sepolia)
        if: steps.verify_step.outcome == 'failure'
        env:
          RPC_URL: https://sepolia.base.org
          PRIVATE_KEY: ${{ secrets.STRATEGY_PRIVATE_KEY }}
          # é—œéµä¿®å¾©ï¼šåŠ ä¸Šå¼•è™Ÿï¼Œé˜²æ­¢è¢«èª¤èªç‚ºæ•´æ•¸
          CONTRACT_ADDRESS: '0xa7D1299B45294e4F34fD0cF0da4100d78Df26090'
        run: |
          echo "ğŸ” æª¢æŸ¥éŒ¢åŒ…é¤˜é¡..."
          cast balance 0x047D2CCBc429EE3Ad4A23414A98aeED0A6E6553c --rpc-url $RPC_URL
          
          echo "âŒ å”è­°å¤±æ•—ï¼æ­£åœ¨åŸ·è¡Œéˆä¸Šåˆ¶è£..."
          BOT_ID=$(node -e "try { console.log(require('./schemas/sample_aSLA.json').bot_id) } catch(e) { console.log('Unknown_Bot') }")
          
          cast send $CONTRACT_ADDRESS "banBot(string,string)" "$BOT_ID" "Protocol Violation"             --rpc-url $RPC_URL             --private-key $PRIVATE_KEY             --legacy
